<UserMacroCommand version="2.0" type="UserMacroCommand">
<Properties/>
<Comments>
 <Comment>
  <Text><![CDATA[<html>
<h3> Implicit Modeling benchmark Macro </h3>
<p>
<b>Input:</b>
</p>
<ul>
<li />One or several Voxet scalar field(s)
<li />One or several objects which should have a constant scalar field value
</ul>

<p><b>Output:</b></p>
<ul>
<li />One equipotential isosurface corresponding to the average scalar field value of each object
<li />[optional] A measure approximation of error (in m)
</ul>
<p>
NB: The gradient computation has artifacts on the boundary voxels of the Voxet. <br/>
Results on points in these voxets may be inaccurate. <br/>
The error approximation may be inaccurate for large distances. <br/>
</p>
</html>]]></Text>
 </Comment>
</Comments>
<Content>
 <Command Type="For">
  <Text>var implicitmethod in $scalarFields$</Text>
  <Command Type="JSVariable">
   <Text>cur_field</Text>
   <VariableType>String</VariableType>
   <VariableScoped>Yes</VariableScoped>
   <VariableId>$scalarFields$[implicitmethod].title</VariableId>
  </Command>
  <Command Type="CommentType">
   <Text>1. Compute gradient norm</Text>
  </Command>
  <Command Type="JSVariable">
   <Text>gradu</Text>
   <VariableType>String</VariableType>
   <VariableScoped>Yes</VariableScoped>
   <VariableId>cur_field + "u"</VariableId>
  </Command>
  <Command Type="JSVariable">
   <Text>gradv</Text>
   <VariableType>String</VariableType>
   <VariableScoped>Yes</VariableScoped>
   <VariableId>cur_field  + "v"</VariableId>
   <Title/>
  </Command>
  <Command Type="JSVariable">
   <Text>gradw</Text>
   <VariableType>String</VariableType>
   <VariableScoped>Yes</VariableScoped>
   <VariableId>cur_field + "w"</VariableId>
  </Command>
  <Command Type="JSVariable">
   <Text>gradnorm</Text>
   <VariableType>String</VariableType>
   <VariableScoped>Yes</VariableScoped>
   <VariableId>cur_field  + "_gradnorm"</VariableId>
   <Title/>
  </Command>
  <Command Type="If">
   <Text>$computeError$</Text>
   <Command Type="CLIType">
    <Text>VoxetCalculateDerivatives</Text>
    <Parameters>
     <on>
      <Value flag="1">$voxet$</Value>
     </on>
     <Property>
      <Value flag="1">cur_field</Value>
     </Property>
     <first_derivatives_only>
      <Value flag="0">"true"</Value>
     </first_derivatives_only>
    </Parameters>
   </Command>
   <Command Type="CLIType">
    <Text>PropertyCreate</Text>
    <Parameters>
     <gobj>
      <Value flag="1">$voxet$</Value>
     </gobj>
     <property_name>
      <Value flag="1">gradnorm</Value>
     </property_name>
     <property_kind>
      <Value flag="0">"Real Number"</Value>
     </property_kind>
     <no_datavalue_specified>
      <Value flag="0">"true"</Value>
     </no_datavalue_specified>
     <no_datavalue>
      <Value flag="0">"default (-99999)"</Value>
     </no_datavalue>
     <number_of_elements>
      <Value flag="0">1</Value>
     </number_of_elements>
     <storage>
      <Value flag="0">"Memory"</Value>
     </storage>
     <interpolation_method>
      <Value flag="0">"Linear"</Value>
     </interpolation_method>
     <property_dimension>
      <Value flag="0">"Nodes"</Value>
     </property_dimension>
     <force_float_property>
      <Value flag="0">"false"</Value>
     </force_float_property>
     <log_set>
      <Value flag="0">""</Value>
     </log_set>
     <sampling_rate>
      <Value flag="0">"0:ft"</Value>
     </sampling_rate>
     <start_md>
      <Value flag="0">"0:ft"</Value>
     </start_md>
     <end_md>
      <Value flag="0">"0:ft"</Value>
     </end_md>
    </Parameters>
   </Command>
   <Command Type="JSVariable">
    <Text>gradnormNDV</Text>
    <VariableType>String</VariableType>
    <VariableScoped>Yes</VariableScoped>
    <VariableId>gradnorm+"_NDV"</VariableId>
   </Command>
   <Command Type="CLIType">
    <Text>GObjApplyScriptOnProperty</Text>
    <Parameters>
     <on>
      <Value flag="1">$voxet$</Value>
     </on>
     <region>
      <Value flag="0">"everywhere"</Value>
     </region>
     <properties>
      <Value flag="1">skua.script_macro_alias_encode({"gradnorm":gradnorm})</Value>
      <Value flag="1">skua.script_macro_alias_encode({"gradnormNDV":gradnormNDV})</Value>
      <Value flag="1">skua.script_macro_alias_encode({"gradu":gradu})</Value>
      <Value flag="1">skua.script_macro_alias_encode({"gradv":gradv})</Value>
      <Value flag="1">skua.script_macro_alias_encode({"gradw":gradw})</Value>
     </properties>
     <script>
      <Value flag="0">"{
// Do not compute on borders to avoid artefacts. 
if(U != 0 || U != NU-1 || V != 0 || V != NV-1 || W != 0 || W != NW-1 ){
    gradnorm=sqrt(gradu*gradu + gradv*gradv + gradw*gradw);
} else {
 gradnorm=gradnormNDV;
}

}
"</Value>
     </script>
     <aliases>
      <Value flag="0">""</Value>
     </aliases>
     <check_no_data_values_automatically>
      <Value flag="0">"true"</Value>
     </check_no_data_values_automatically>
     <file_name>
      <Value flag="0">"None"</Value>
     </file_name>
    </Parameters>
   </Command>
   <Command Type="If">
    <Text>$cleanup$</Text>
    <Command Type="CLIType">
     <Text>PropertyRemove</Text>
     <Parameters>
      <on>
       <Value flag="1">$voxet$</Value>
      </on>
      <name>
       <Value flag="1">gradu</Value>
      </name>
     </Parameters>
    </Command>
    <Command Type="CLIType">
     <Text>PropertyRemove</Text>
     <Parameters>
      <on>
       <Value flag="1">$voxet$</Value>
      </on>
      <name>
       <Value flag="1">gradv</Value>
      </name>
     </Parameters>
    </Command>
    <Command Type="CLIType">
     <Text>PropertyRemove</Text>
     <Parameters>
      <on>
       <Value flag="1">$voxet$</Value>
      </on>
      <name>
       <Value flag="1">gradw</Value>
      </name>
     </Parameters>
    </Command>
   </Command>
   <Command Type="EndOfScope"/>
  </Command>
  <Command Type="EndOfScope"/>
  <Command Type="CommentType">
   <Text>2. Find the scalar field values corresponding to each data and compute the local error. </Text>
  </Command>
  <Command Type="For">
   <Text>var dataobj in $data$</Text>
   <Command Type="JSVariable">
    <Text>cur_data</Text>
    <VariableType>Object</VariableType>
    <VariableScoped>Yes</VariableScoped>
    <VariableId>$data$[dataobj]</VariableId>
   </Command>
   <Command Type="CLIType">
    <Text>PropertyFillPointwiseFrom</Text>
    <Parameters>
     <on>
      <Value flag="1">$data$[dataobj]</Value>
     </on>
     <region>
      <Value flag="0">"everywhere"</Value>
     </region>
     <new_property_name>
      <Value flag="1">cur_field</Value>
     </new_property_name>
     <from>
      <Value flag="1">$voxet$</Value>
     </from>
     <from_region>
      <Value flag="0">"everywhere"</Value>
     </from_region>
     <property>
      <Value flag="1">cur_field</Value>
     </property>
     <share_property_class>
      <Value flag="0">"true"</Value>
     </share_property_class>
    </Parameters>
   </Command>
   <Command Type="CLIType">
    <Text>PropertyComputeStatistics</Text>
    <Parameters>
     <on>
      <Value flag="1">$data$[dataobj]</Value>
     </on>
     <property>
      <Value flag="1">$scalarFields$[implicitmethod]</Value>
     </property>
     <region>
      <Value flag="0">"everywhere"</Value>
     </region>
     <minimum>
      <Value flag="0">"true"</Value>
     </minimum>
     <maximum>
      <Value flag="0">"true"</Value>
     </maximum>
     <mean>
      <Value flag="0">"true"</Value>
     </mean>
     <standard_deviation>
      <Value flag="0">"true"</Value>
     </standard_deviation>
     <quantile>
      <Value flag="0">"true"</Value>
     </quantile>
     <quantile_list_mode>
      <Value flag="0">"true"</Value>
     </quantile_list_mode>
     <quantile_list>
      <Value flag="0">10</Value>
      <Value flag="0">25</Value>
      <Value flag="0">50</Value>
      <Value flag="0">75</Value>
      <Value flag="0">90</Value>
     </quantile_list>
     <quantile_step_mode>
      <Value flag="0">"false"</Value>
     </quantile_step_mode>
     <quantile_step>
      <Value flag="0">10.</Value>
     </quantile_step>
    </Parameters>
    <Result>
     <ResultVariable>stats</ResultVariable>
     <ResultKey>statistics</ResultKey>
     <ResultType>CLIStatistics</ResultType>
     <ResultIsArray>true</ResultIsArray>
    </Result>
   </Command>
   <Command Type="JavaScript">
    <Text>        
        // Does not work for some reason.
        // PDGM.assert(stats !== undefined);
        // var avg = stats[0].mean;
        
        // Get the property values manager
        var PVMgr = interfaces.findManager('PropertyValues');
        PDGM.assert(PVMgr !== undefined);

        // Get the current scalar property
        var curobj = $data$[dataobj];
        var curfieldtable = PVMgr.findChildrenOf(curobj, cur_field, curobj );
        PDGM.assertEqual(curfieldtable.length, 1);
        var curfield = curfieldtable[0];
      
        var vals = curfield.values;
        var average = 0;
        // var average2 = 0;
        var count = 0;
        for( var ival in vals ){
            average += vals[ival];
            // average2 += vals[ival]*vals[ival];
            count++;
        }
        average /= count;
        // average2 /= count;
        // var stdDev = Math.sqrt((average2 - average*average) *count / (count-1));
        skua.logInfo( curobj.title + "Average of " + cur_field + ": " + average );
        // skua.logInfo("Std Deviation = " + stdDev );
</Text>
    <Title>JavaScript</Title>
   </Command>
   <Command Type="JSVariable">
    <Text>surface</Text>
    <VariableType>String</VariableType>
    <VariableScoped>Yes</VariableScoped>
    <VariableId>"H_" + average.toFixed(3) + cur_field</VariableId>
   </Command>
   <Command Type="CLIType">
    <Text>TSurfCreateFromIsovalue</Text>
    <Parameters>
     <name>
      <Value flag="1">surface</Value>
     </name>
     <grid>
      <Value flag="1">$voxet$</Value>
     </grid>
     <property>
      <Value flag="1">cur_field</Value>
     </property>
     <iso_value>
      <Value flag="1">average</Value>
     </iso_value>
     <close>
      <Value flag="0">"none"</Value>
     </close>
     <snap_to_centers>
      <Value flag="0">"false"</Value>
     </snap_to_centers>
     <check_normals>
      <Value flag="0">"false"</Value>
     </check_normals>
     <beautify_triangles>
      <Value flag="0">"false"</Value>
     </beautify_triangles>
     <print_statistics>
      <Value flag="0">"false"</Value>
     </print_statistics>
    </Parameters>
    <Result>
     <ResultVariable>Surf</ResultVariable>
     <ResultKey>created</ResultKey>
     <ResultType>TSurf</ResultType>
     <ResultIsArray>false</ResultIsArray>
    </Result>
   </Command>
   <Command Type="If">
    <Text>$computeError$</Text>
    <Command Type="CLIType">
     <Text>PropertyFillPointwiseFrom</Text>
     <Parameters>
      <on>
       <Value flag="1">$data$[dataobj]</Value>
      </on>
      <region>
       <Value flag="0">"everywhere"</Value>
      </region>
      <new_property_name>
       <Value flag="1">gradnorm</Value>
      </new_property_name>
      <from>
       <Value flag="1">$voxet$</Value>
      </from>
      <from_region>
       <Value flag="0">"everywhere"</Value>
      </from_region>
      <property>
       <Value flag="1">gradnorm</Value>
      </property>
      <share_property_class>
       <Value flag="0">"true"</Value>
      </share_property_class>
     </Parameters>
    </Command>
    <Command Type="JSVariable">
     <Text>cur_error</Text>
     <VariableType>String</VariableType>
     <VariableScoped>Yes</VariableScoped>
     <VariableId>cur_field  + "_error_m"</VariableId>
     <Title/>
    </Command>
    <Command Type="JSVariable">
     <Text>cur_sqerror</Text>
     <VariableType>String</VariableType>
     <VariableScoped>Yes</VariableScoped>
     <VariableId>cur_field  + "_squared_error"</VariableId>
     <Title/>
    </Command>
    <Command Type="JSVariable">
     <Text>cur_Avgsqerror</Text>
     <VariableType>String</VariableType>
     <VariableScoped>Yes</VariableScoped>
     <VariableId>cur_sqerror  + ".mean"</VariableId>
     <Title/>
    </Command>
    <Command Type="CLIType">
     <Text>PropertyCreate</Text>
     <Parameters>
      <gobj>
       <Value flag="1">$data$[dataobj]</Value>
      </gobj>
      <property_name>
       <Value flag="1">cur_error</Value>
      </property_name>
      <property_kind>
       <Value flag="0">"Real Number"</Value>
      </property_kind>
      <no_datavalue_specified>
       <Value flag="0">"true"</Value>
      </no_datavalue_specified>
      <no_datavalue>
       <Value flag="0">"default (-99999)"</Value>
      </no_datavalue>
      <number_of_elements>
       <Value flag="0">1</Value>
      </number_of_elements>
      <storage>
       <Value flag="0">"Memory"</Value>
      </storage>
      <interpolation_method>
       <Value flag="0">"Linear"</Value>
      </interpolation_method>
      <property_dimension>
       <Value flag="0">"Default"</Value>
      </property_dimension>
      <force_float_property>
       <Value flag="0">"false"</Value>
      </force_float_property>
      <log_set>
       <Value flag="0">""</Value>
      </log_set>
      <sampling_rate>
       <Value flag="0">"0:ft"</Value>
      </sampling_rate>
      <start_md>
       <Value flag="0">"0:ft"</Value>
      </start_md>
      <end_md>
       <Value flag="0">"0:ft"</Value>
      </end_md>
     </Parameters>
    </Command>
    <Command Type="CLIType">
     <Text>PropertyCreate</Text>
     <Parameters>
      <gobj>
       <Value flag="1">$data$[dataobj]</Value>
      </gobj>
      <property_name>
       <Value flag="1">cur_sqerror</Value>
      </property_name>
      <property_kind>
       <Value flag="0">"Real Number"</Value>
      </property_kind>
      <no_datavalue_specified>
       <Value flag="0">"true"</Value>
      </no_datavalue_specified>
      <no_datavalue>
       <Value flag="0">"default (-99999)"</Value>
      </no_datavalue>
      <number_of_elements>
       <Value flag="0">1</Value>
      </number_of_elements>
      <storage>
       <Value flag="0">"Memory"</Value>
      </storage>
      <interpolation_method>
       <Value flag="0">"Linear"</Value>
      </interpolation_method>
      <property_dimension>
       <Value flag="0">"Nodes"</Value>
      </property_dimension>
      <force_float_property>
       <Value flag="0">"false"</Value>
      </force_float_property>
      <log_set>
       <Value flag="0">""</Value>
      </log_set>
      <sampling_rate>
       <Value flag="0">"0:ft"</Value>
      </sampling_rate>
      <start_md>
       <Value flag="0">"0:ft"</Value>
      </start_md>
      <end_md>
       <Value flag="0">"0:ft"</Value>
      </end_md>
     </Parameters>
    </Command>
    <Command Type="CLIType">
     <Text>GObjApplyScriptOnProperty</Text>
     <Parameters>
      <on>
       <Value flag="1">$data$[dataobj]</Value>
      </on>
      <region>
       <Value flag="0">"everywhere"</Value>
      </region>
      <properties>
       <Value flag="1">skua.script_macro_alias_encode({"average":average})</Value>
       <Value flag="1">skua.script_macro_alias_encode({"cur_Avgsqerror":cur_Avgsqerror})</Value>
       <Value flag="1">skua.script_macro_alias_encode({"cur_data":cur_data})</Value>
       <Value flag="1">skua.script_macro_alias_encode({"cur_error":cur_error})</Value>
       <Value flag="1">skua.script_macro_alias_encode({"cur_field":cur_field})</Value>
       <Value flag="1">skua.script_macro_alias_encode({"cur_sqerror":cur_sqerror})</Value>
       <Value flag="1">skua.script_macro_alias_encode({"cur_sqerror.mean":"local"})</Value>
       <Value flag="1">skua.script_macro_alias_encode({"gradnorm":gradnorm})</Value>
       <Value flag="1">skua.script_macro_alias_encode({"gradnormNDV":gradnormNDV})</Value>
      </properties>
      <script>
       <Value flag="0">"{
if( gradnorm != gradnormNDV ){
  // cur_error = (cur_field - cur_field.mean)/gradnorm;
  cur_error = (cur_field - average)/gradnorm;
  cur_sqerror = cur_error *cur_error ;
} else {
  cur_error =round(-99999);
  cur_sqerror =round(-99999);
}
}
END {
print \"Cur data expected scalar value is \", average;
print \"Mean squared error (m^2) on\", cur_data, \" is \", cur_Avgsqerror;
}
"</Value>
      </script>
      <aliases>
       <Value flag="0">""</Value>
      </aliases>
      <check_no_data_values_automatically>
       <Value flag="0">"true"</Value>
      </check_no_data_values_automatically>
      <file_name>
       <Value flag="0">"None"</Value>
      </file_name>
     </Parameters>
    </Command>
   </Command>
   <Command Type="EndOfScope"/>
  </Command>
  <Command Type="EndOfScope"/>
  <Command Type="If">
   <Text>$cleanup$</Text>
   <Command Type="CLIType">
    <Text>PropertyRemove</Text>
    <Parameters>
     <on>
      <Value flag="1">$voxet$</Value>
     </on>
     <name>
      <Value flag="1">gradnorm</Value>
     </name>
    </Parameters>
   </Command>
  </Command>
  <Command Type="EndOfScope"/>
 </Command>
 <Command Type="EndOfScope"/>
</Content>
<Variables>
 <Variable>
  <alias>$voxet$</alias>
  <type>Voxet</type>
  <multi-selection>No</multi-selection>
  <default_value></default_value>
  <cmdName>TSurfCreateFromIsovalue</cmdName>
  <cmdParamName>grid</cmdParamName>
  <cmdParamEltIndex>0</cmdParamEltIndex>
 </Variable>
 <Variable>
  <alias>$scalarFields$</alias>
  <type>String</type>
  <default_value>/Property</default_value>
  <multi-selection>Yes</multi-selection>
  <cmdName>TSurfCreateFromIsovalue</cmdName>
  <cmdParamName>grid</cmdParamName>
  <cmdParamEltIndex>0</cmdParamEltIndex>
  <optional>No</optional>
  <dependency>$voxet$.properties</dependency>
 </Variable>
 <Variable>
  <alias>$data$</alias>
  <type>AtomicGroup</type>
  <optional>No</optional>
  <multi-selection>Yes</multi-selection>
  <default_value/>
  <cmdName>PropertyFillPointwiseFrom</cmdName>
  <cmdParamName>PointPropertyClient</cmdParamName>
  <cmdParamEltIndex>0</cmdParamEltIndex>
 </Variable>
 <Variable>
  <alias>$computeError$</alias>
  <type>Boolean</type>
  <default_value>True</default_value>
 </Variable>
 <Variable>
  <alias>$cleanup$</alias>
  <type>Boolean</type>
  <default_value>True</default_value>
 </Variable>
 <Variable>
  <alias>$RUN.JR$</alias>
  <type>Integer</type>
  <default_value>0</default_value>
  <comment>Internal variable for Jacta realizations</comment>
  <built-in>true</built-in>
 </Variable>
 <Variable>
  <alias>$RUN.I$</alias>
  <type>Integer</type>
  <default_value>1</default_value>
  <comment>Internal variable for simulation index</comment>
  <built-in>true</built-in>
 </Variable>
 <Variable>
  <alias>$RUN.N$</alias>
  <type>Integer</type>
  <default_value>1</default_value>
  <comment>Internal variable for number of simulations</comment>
  <built-in>true</built-in>
 </Variable>
</Variables>
<DialogSpecifications/>

</UserMacroCommand>
